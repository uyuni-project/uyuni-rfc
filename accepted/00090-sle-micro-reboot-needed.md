- Feature Name: SLE Micro - report when a reboot is needed
- Start Date: 2021-09-23

# Summary
[summary]: #summary

After a system level change in SLE Micro, SUSE Manager should indicate in the UI when a reboot is needed.

# Motivation
[motivation]: #motivation

Currently, for SLE Micro, we display the following message on the detail page: `OS with transactional updates: please reboot after any packages and/or channel changes`.

This is not ideal when it comes to usability. The user is responsible for knowing when a reboot is needed, and scheduling those reboots.


# Detailed design
[design]: #detailed-design

The SLE Micro uses transactional updates. Transactional updates are atomic (all updates are applied only if all updates succeed) and support rollbacks. They don't affect a running system as no changes are activated until after the system is rebooted.
To be able to have up-to-date information regarding reboot needed, we need to constant read this information from the system.
For that, this proposed solution is based on the following steps:
 - Create a beacon module to constantly check if a reboot is required
 - If the reboot required information changes in the minion, notify Suse Manager
 - Store the status in postgresql
 - Report reboot needed in the UI based on this column

The details of the beacon module are explained below.

### The beacon module
The beacon module will use `transactional_update` module to check for [pending transactions](https://docs.saltproject.io/en/3004/ref/modules/all/salt.modules.transactional_update.html#salt.modules.transactional_update.pending_transaction), and based on its result determine if a reboot is required for that system. Initially the beacon will be configured to run every 10 seconds.

In the beacon, the information will be stored in `__context__` in order to compare the current status with the previous one and, only if the status changed, it will fire an event.

The Java Salt Reactor will be adapted to identify events coming from this beacon module and update the reboot needed information in postgres. 

The query to identify `Requiring reboot` systems will be updated to consider the new column together with the current strategy, in order to check if a system needs to be rebooted and, if so, display the message in the UI.

# Drawbacks
[drawbacks]: #drawbacks
Although running `transactional_update.pending_transaction` is based only in the number of the snapshots from `snapper` and therefore it is light to run, it is necessary to monitor if running it every 10 seconds will not cause any relevant extra load in the systems.

# Alternatives
[alternatives]: #alternatives
In order to identify if a reboot is needed, the following alternatives were considered:

 - Use `snapper` to check if the currently booted snapshot is the default one. If not, it can indicate that a reboot is required considering that the default snapshot is probably a new one generated by some change in the current one. This alternative is not 100% precise, considering that an old snapshot could be booted by the admin because the new one didn't work, for example. Futhermore, `transactional_update.pending_transaction` already encapsulate a similar approach and it seems better to depends on it and automatically have any update made on this strategy.

 - Check for filesystem changes in the snapshots directory. New snapshots are stored in the filesystem, monitoring it can indicate that new snapshots were created and a reboot should be required in order to activate the changes. The main advantage of this strategy would be to monitor the changes using `inotify` beacon instead of having to run specific commands. However, it introduces some new challenges in order to keep the reboot needed flag up-to-date: if a snapshot is dropped, how to know how this affects the reboot? We could consider that any changes to the filesystem would indicate a reboot needed that would only be removed when a start event is processed in the master, however, this is not an accurate approach.


In order to keep the reboot needed information up-to-date in SUSE Manager, using an execution module instead of a beacon was also considered:

 - In that case, it would be necessary to run the execution module after every `state.apply` and parse its results in the job return. This approach would require to change the `sls` files in order to include the `transactional_update.pending_transactions` module.

# Unresolved questions
[unresolved]: #unresolved-questions
